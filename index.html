<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teste – Assincronias Ventilatórias + Mecânica (Educacional)</title>
  <style>
    :root{--bg:#ffffff;--fg:#111827;--muted:#6b7280;--b:#e5e7eb;--card:#f9fafb;--pri:#111827;}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Arial,Helvetica,sans-serif;}
    header{padding:16px 18px;border-bottom:1px solid var(--b);background:#fff;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{font-size:13px;color:var(--muted);line-height:1.4}
    .wrap{max-width:1050px;margin:0 auto;padding:14px 16px 44px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px;}
    .tab{border:1px solid var(--b);background:#fff;border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
    .tab.active{background:var(--pri);color:#fff;border-color:var(--pri)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid var(--b);background:var(--card);border-radius:12px;padding:12px 12px;margin:10px 0;}
    .card h2{font-size:14px;margin:0 0 8px;}
    label{display:block;font-size:13px;font-weight:700;margin:0 0 6px;}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:10px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .chk{display:flex;gap:8px;align-items:flex-start;margin:7px 0}
    .chk input{margin-top:2px}
    .pill{display:inline-block;border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:11px;color:#374151;background:#fff;margin-left:6px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--b);background:#fff;border-radius:10px;padding:10px 12px;font-size:13px;cursor:pointer}
    button.primary{background:var(--pri);color:#fff;border-color:var(--pri)}
    .out h3{font-size:13px;margin:0 0 8px}
    .kv{margin:6px 0;font-size:13px;line-height:1.35}
    .kv b{display:inline-block;min-width:140px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .small{font-size:12px;color:#374151;line-height:1.35}
    footer{border-top:1px solid var(--b);padding:14px 18px;color:#374151;font-size:12px;line-height:1.45}
    .warn{background:#fff;border:1px dashed #d1d5db}
  </style>
</head>

<body>
<header>
  <h1>Ferramenta educacional – Curvas ventilatórias</h1>
  <div class="sub">Identificação de padrões por sinais observáveis nas curvas. Não prescreve ajustes, não define alvos numéricos e não substitui julgamento clínico.</div>

  <div class="tabs" role="tablist" aria-label="Navegação">
    <button class="tab active" id="tabAss" type="button" onclick="showTab('ass')">Assincronias</button>
    <button class="tab" id="tabMec" type="button" onclick="showTab('mec')">Mecânica</button>
    <button class="tab" id="tabSobre" type="button" onclick="showTab('sobre')">Sobre</button>
  </div>
</header>

<div class="wrap">
  <!-- ===================== ASSINCRONIAS ===================== -->
  <section id="secAss" style="display:block;">
    <div class="card">
      <h2>Modo de leitura <span class="pill">Saída micro / compacta</span></h2>
      <div class="row">
        <label class="chk"><input type="radio" name="modo_saida_ass" value="micro" checked> <span><b>Micro</b><div class="muted">Flashcard (4 linhas). Melhor para leitura rápida.</div></span></label>
        <label class="chk"><input type="radio" name="modo_saida_ass" value="compacta"> <span><b>Compacta</b><div class="muted">Blocos estruturais (sinais, leitura, diferenciação, limites).</div></span></label>
      </div>
    </div>

    <div class="card">
      <h2>Marque os sinais observáveis</h2>
      <div class="muted">Selecione apenas o que está visível e repetitivo. Sinais conflitantes reduzem confiança.</div>

      <div class="grid" style="margin-top:10px;">
        <div class="card" style="margin:0;background:#fff;">
          <h2>Disparo / expiração</h2>
          <label class="chk"><input type="checkbox" data-signal="deflexao_expiratoria_sem_ciclo"> Deflexão em pressão/fluxo na expiração sem ciclo ventilatório</label>
          <label class="chk"><input type="checkbox" data-signal="fluxo_expiratorio_nao_zera"> Fluxo expiratório não retorna à linha de base (não zera)</label>
          <label class="chk"><input type="checkbox" data-signal="expiracao_truncada"> Expiração truncada / curta no traçado</label>
          <label class="chk"><input type="checkbox" data-signal="repeticao_temporal"> Padrão repetido em múltiplos ciclos</label>
        </div>

        <div class="card" style="margin:0;background:#fff;">
          <h2>Inspiração / ciclagem</h2>
          <label class="chk"><input type="checkbox" data-signal="dois_ciclos_consecutivos_intervalo_minimo"> Dois ciclos consecutivos com intervalo expiratório mínimo</label>
          <label class="chk"><input type="checkbox" data-signal="empilhamento_volume"> Empilhamento de volume (incremento duplo)</label>
          <label class="chk"><input type="checkbox" data-signal="esforco_no_fim_inspiratorio_pre_ciclagem"> Esforço no final da inspiração antes da ciclagem</label>
          <label class="chk"><input type="checkbox" data-signal="esforco_expiratorio_durante_inspiracao"> Esforço expiratório durante a inspiração</label>
          <label class="chk"><input type="checkbox" data-signal="concavidade_fluxo_inspiratorio"> Concavidade/abaulamento do fluxo inspiratório</label>
          <label class="chk"><input type="checkbox" data-signal="predominio_inicio_meio_inspiracao"> Sinais predominam no início/meio da inspiração</label>
        </div>
      </div>

      <div class="card warn">
        <h2>Sinais de conflito / baixa confiabilidade</h2>
        <div class="muted">Use quando estiver claro. Isso reduz a confiança automaticamente.</div>
        <div class="grid" style="margin-top:10px;">
          <div>
            <label class="chk"><input type="checkbox" data-signal="tosse_artefato"> Tosse/artefato evidente</label>
            <label class="chk"><input type="checkbox" data-signal="artefato_movimento"> Movimento/ruído evidente</label>
          </div>
          <div>
            <label class="chk"><input type="checkbox" data-signal="vazamento_importante"> Vazamento importante</label>
            <label class="chk"><input type="checkbox" data-signal="ruido_sensor"> Ruído de sensor / linha de base instável</label>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" type="button" onclick="rodarAnaliseAss()">Rodar análise (Assincronias)</button>
        <button type="button" onclick="limparChecks('secAss')">Limpar seleções</button>
      </div>
    </div>

    <div class="card out" id="outAss" style="display:none;">
      <h2>Resultado</h2>
      <div id="outAssBody"></div>
    </div>
  </section>

  <!-- ===================== MECÂNICA ===================== -->
  <section id="secMec" style="display:none;">
    <div class="card">
      <h2>Modo de leitura <span class="pill">Saída micro / compacta</span></h2>
      <div class="row">
        <label class="chk"><input type="radio" name="modo_saida_mec" value="micro" checked> <span><b>Micro</b><div class="muted">Flashcard (4 linhas).</div></span></label>
        <label class="chk"><input type="radio" name="modo_saida_mec" value="compacta"> <span><b>Compacta</b><div class="muted">Blocos estruturais.</div></span></label>
      </div>
    </div>

    <div class="card">
      <h2>Marque os sinais observáveis (mecânica)</h2>
      <div class="muted">Interpretação por padrão de forma e repetição. Sem valores numéricos.</div>

      <div class="grid" style="margin-top:10px;">
        <div class="card" style="margin:0;background:#fff;">
          <h2>Fluxo</h2>
          <label class="chk"><input type="checkbox" data-signal="fluxo_expiratorio_prolongado_esvaziamento_lento"> Fluxo expiratório prolongado / esvaziamento lento</label>
          <label class="chk"><input type="checkbox" data-signal="fluxo_expiratorio_nao_zera"> Fluxo expiratório não zera</label>
          <label class="chk"><input type="checkbox" data-signal="expiracao_truncada_em_demanda"> Expiração truncada em alta demanda</label>
          <label class="chk"><input type="checkbox" data-signal="repeticao_temporal"> Padrão repetido em múltiplos ciclos</label>
        </div>

        <div class="card" style="margin:0;background:#fff;">
          <h2>Pressão / volume</h2>
          <label class="chk"><input type="checkbox" data-signal="subida_lenta_pressao_inicio_inspiracao"> Subida lenta de pressão no início da inspiração</label>
          <label class="chk"><input type="checkbox" data-signal="baixa_variacao_volume_relativa_a_pressao"> Baixa variação de volume relativa ao padrão de pressão</label>
          <label class="chk"><input type="checkbox" data-signal="coerencia_pressao_volume"> Coerência repetida entre pressão e volume ao longo dos ciclos</label>
          <label class="chk"><input type="checkbox" data-signal="sinais_esforco_ao_longo_inspiracao"> Sinais de esforço ao longo da inspiração (deformação do traçado)</label>
        </div>
      </div>

      <div class="card warn">
        <h2>Sinais de conflito / baixa confiabilidade</h2>
        <div class="grid" style="margin-top:10px;">
          <div>
            <label class="chk"><input type="checkbox" data-signal="vazamento_importante"> Vazamento importante</label>
            <label class="chk"><input type="checkbox" data-signal="ruido_sensor"> Ruído de sensor / linha de base instável</label>
          </div>
          <div>
            <label class="chk"><input type="checkbox" data-signal="mudanca_modo"> Mudança de modo/condição entre ciclos</label>
            <label class="chk"><input type="checkbox" data-signal="artefato_movimento"> Movimento/artefato evidente</label>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" type="button" onclick="rodarAnaliseMec()">Rodar análise (Mecânica)</button>
        <button type="button" onclick="limparChecks('secMec')">Limpar seleções</button>
      </div>
    </div>

    <div class="card out" id="outMec" style="display:none;">
      <h2>Resultado</h2>
      <div id="outMecBody"></div>
    </div>
  </section>

  <!-- ===================== SOBRE ===================== -->
  <section id="secSobre" style="display:none;">
    <div class="card">
      <h2>Escopo e limites</h2>
      <div class="small">
        <b>Escopo:</b> leitura estruturada de padrões em curvas (pressão, fluxo e volume).<br/>
        <b>Não é conduta:</b> não prescreve ajustes, não define alvos numéricos e não substitui julgamento clínico.<br/>
        <b>Uso:</b> educacional, treinamento e padronização de raciocínio.<br/>
      </div>
    </div>
  </section>
</div>

<footer>
  <b>Aviso educacional:</b> Ferramenta educacional destinada à organização da leitura das curvas ventilatórias. Não orienta ajustes nem substitui julgamento clínico.
</footer>

<script>
/* ========================= BANCO (JSON) =========================
   Você pode mover para arquivo .json depois. Aqui fica embutido.
*/
const ASS_DB = {
  versao:"1.0",
  campos_confianca:{
    confianca_niveis:["baixa","media","alta"],
    regra_geral:{
      alta:"sinal_chave_presente = true E n_suporte >= 2 E n_conflitos = 0",
      media:"(sinal_chave_presente = true E n_suporte >= 1) OU (sinal_chave_presente = false E n_suporte >= 3) OU (n_conflitos = 1)",
      baixa:"casos restantes (poucos sinais, sinais inespecificos, ruido, ou n_conflitos >= 2)"
    }
  },
  assincronias:[
    {
      id:"esforco_inefetivo",
      padrao:"Esforço inefetivo",
      micro:{
        sinal_chave:"Deflexão em pressão ou fluxo durante a expiração sem ciclo ventilatório.",
        leitura:"Esforço neural não convertido em disparo efetivo.",
        confirmar:"Expiração incompleta e repetição temporal do evento."
      },
      compacta:{
        sinais_dominantes:"Deflexão expiratória sem ciclo; padrão repetido.",
        leitura_fisiologica:"Mismatch entre esforço e disparo: o esforço ocorre, mas não resulta em ciclo.",
        como_diferenciar:"Ausência de dois ciclos completos e ausência de empilhamento de volume.",
        observar_a_seguir:"Associação com expiração incompleta e recorrência em múltiplos ciclos.",
        se_resolver:"Desaparecimento das deflexões expiratórias sem disparo.",
        limites:"Vazamento e ruído de sensor podem simular deflexões."
      },
      confianca_regras:{
        sinais_chave:["deflexao_expiratoria_sem_ciclo"],
        sinais_suporte:["fluxo_expiratorio_nao_zera","expiracao_truncada","repeticao_temporal","associacao_demanda_aumentada"],
        conflitos:["tosse_artefato","vazamento_importante","ruido_sensor","artefato_movimento"]
      }
    },
    {
      id:"duplo_disparo",
      padrao:"Duplo disparo",
      micro:{
        sinal_chave:"Dois ciclos inspiratórios consecutivos com intervalo expiratório mínimo.",
        leitura:"Tempo neural inspiratório excede o tempo mecânico.",
        confirmar:"Empilhamento de volume e esforço no final do primeiro ciclo."
      },
      compacta:{
        sinais_dominantes:"Dois ciclos consecutivos com intervalo expiratório mínimo; empilhamento de volume.",
        leitura_fisiologica:"Persistência do esforço após o término do primeiro ciclo.",
        como_diferenciar:"Exige dois ciclos completos; pode coexistir com sinais de ciclagem precoce.",
        observar_a_seguir:"Sinal de esforço no final do primeiro ciclo e repetição em sequência.",
        se_resolver:"Presença de expiração identificável entre ciclos; desaparecimento do empilhamento.",
        limites:"Alguns modos e janelas de visualização podem mascarar empilhamento."
      },
      confianca_regras:{
        sinais_chave:["dois_ciclos_consecutivos_intervalo_minimo"],
        sinais_suporte:["empilhamento_volume","repeticao_temporal","esforco_no_fim_do_primeiro_ciclo"],
        conflitos:["artefato_movimento","tosse_artefato","ruido_sensor","vazamento_importante"]
      }
    },
    {
      id:"ciclagem_precoce",
      padrao:"Ciclagem precoce",
      micro:{
        sinal_chave:"Esforço persistente no final da inspiração antes da ciclagem.",
        leitura:"Ciclo mecânico termina antes do fim do esforço neural.",
        confirmar:"Progressão ocasional para duplo disparo."
      },
      compacta:{
        sinais_dominantes:"Esforço no final da inspiração antes da transição para expiração.",
        leitura_fisiologica:"Tempo mecânico inspiratório menor que o tempo neural.",
        como_diferenciar:"Sinais concentrados no fim inspiratório (não no início/meio).",
        observar_a_seguir:"Repetição do esforço no mesmo ponto do ciclo; episódios de duplo disparo.",
        se_resolver:"Final inspiratório sem entalhes de esforço e menor ocorrência de ciclos adicionais.",
        limites:"Tosse e artefatos no fim do ciclo reduzem confiabilidade."
      },
      confianca_regras:{
        sinais_chave:["esforco_no_fim_inspiratorio_pre_ciclagem"],
        sinais_suporte:["repeticao_temporal"],
        conflitos:["tosse_artefato","artefato_movimento","ruido_sensor"]
      }
    },
    {
      id:"ciclagem_tardia",
      padrao:"Ciclagem tardia",
      micro:{
        sinal_chave:"Esforço expiratório durante a fase inspiratória.",
        leitura:"Inspiração mecânica prolongada além do tempo neural.",
        confirmar:"Irregularidade repetida no final da inspiração."
      },
      compacta:{
        sinais_dominantes:"Esforço expiratório durante inspiração, sobretudo no final.",
        leitura_fisiologica:"Tempo mecânico inspiratório maior que o tempo neural.",
        como_diferenciar:"Irregularidade de fim inspiratório sem expiração incompleta como achado dominante.",
        observar_a_seguir:"Repetição do padrão em múltiplos ciclos e na mesma fase.",
        se_resolver:"Transição inspiração–expiração mais suave e sem esforço expiratório na inspiração.",
        limites:"Artefatos no fim do ciclo podem simular irregularidade."
      },
      confianca_regras:{
        sinais_chave:["esforco_expiratorio_durante_inspiracao"],
        sinais_suporte:["repeticao_temporal"],
        conflitos:["artefato_movimento","tosse_artefato","ruido_sensor"]
      }
    },
    {
      id:"auto_peep",
      padrao:"Auto-PEEP dinâmica / expiração incompleta",
      micro:{
        sinal_chave:"Fluxo expiratório não retorna à linha de base antes do próximo ciclo.",
        leitura:"Esvaziamento pulmonar incompleto.",
        confirmar:"Associação com esforços inefetivos."
      },
      compacta:{
        sinais_dominantes:"Fluxo expiratório não zera antes do próximo ciclo (padrão consistente).",
        leitura_fisiologica:"Esvaziamento incompleto por tempo expiratório efetivo insuficiente.",
        como_diferenciar:"Persistência em múltiplos ciclos e associação com outras assincronias dependentes da expiração.",
        observar_a_seguir:"Relação com esforços inefetivos e manutenção do fluxo expiratório pendente.",
        se_resolver:"Retorno do fluxo expiratório à linha de base antes do próximo ciclo.",
        limites:"Vazamentos dificultam a leitura da linha de base."
      },
      confianca_regras:{
        sinais_chave:["fluxo_expiratorio_nao_zera"],
        sinais_suporte:["repeticao_temporal","expiracao_truncada"],
        conflitos:["vazamento_importante","ruido_sensor","artefato_movimento"]
      }
    },
    {
      id:"fluxo_insuficiente",
      padrao:"Fluxo insuficiente",
      micro:{
        sinal_chave:"Concavidade ou abaulamento do fluxo inspiratório.",
        leitura:"Demanda inspiratória maior que a entrega.",
        confirmar:"Sinais predominam no início ou meio da inspiração."
      },
      compacta:{
        sinais_dominantes:"Concavidade/abaulamento do fluxo inspiratório; sinais de esforço na inspiração.",
        leitura_fisiologica:"Mismatch oferta–demanda de fluxo durante a inspiração.",
        como_diferenciar:"Predomínio de sinais no início/meio inspiratório (não apenas no final).",
        observar_a_seguir:"Persistência do padrão ao longo dos ciclos e variabilidade com demanda.",
        se_resolver:"Fluxo mais regular e menor evidência de esforço durante a inspiração.",
        limites:"A forma do fluxo é dependente do modo; interpretar no contexto."
      },
      confianca_regras:{
        sinais_chave:["concavidade_fluxo_inspiratorio"],
        sinais_suporte:["predominio_inicio_meio_inspiracao","repeticao_temporal"],
        conflitos:["artefato_movimento","ruido_sensor"]
      }
    },
    {
      id:"fluxo_excessivo",
      padrao:"Fluxo excessivo / sobreassistência",
      micro:{
        sinal_chave:"Pico de fluxo curto e elevado com relaxamento precoce do esforço.",
        leitura:"Entrega excede a demanda em parte do ciclo.",
        confirmar:"Padrão bifásico consistente."
      },
      compacta:{
        sinais_dominantes:"Pico de fluxo curto e alto; relaxamento precoce do esforço; possível bifasia consistente.",
        leitura_fisiologica:"Entrega excede demanda em parte do ciclo, com alterações secundárias no padrão de esforço.",
        como_diferenciar:"Repetição do padrão e coerência fase a fase (não episódico).",
        observar_a_seguir:"Bifasia persistente e irregularidade inspiratória repetida.",
        se_resolver:"Redução de bifasia e de sinais de esforço paradoxal.",
        limites:"Categoria com alta dependência do modo; usar confiança conservadora quando faltam sinais discriminatórios."
      },
      confianca_regras:{
        sinais_chave:["pico_fluxo_alto_curto_com_relaxamento_precoce"],
        sinais_suporte:["repeticao_temporal"],
        conflitos:["artefato_movimento","ruido_sensor","vazamento_importante"]
      }
    },
    {
      id:"disparo_reverso",
      padrao:"Disparo reverso",
      micro:{
        sinal_chave:"Esforço do paciente ocorre após o início do ciclo mandatário.",
        leitura:"Ciclo mecânico desencadeia o esforço neural.",
        confirmar:"Intervalo esforço–ciclo relativamente constante."
      },
      compacta:{
        sinais_dominantes:"Acoplamento temporal regular entre ciclo mandatário e esforço pós-início do ciclo.",
        leitura_fisiologica:"Entrainment: o ciclo mecânico induz esforço neural.",
        como_diferenciar:"Intervalo esforço–ciclo relativamente constante e persistente em múltiplos ciclos.",
        observar_a_seguir:"Persistência do acoplamento e possível empilhamento secundário ocasional.",
        se_resolver:"Desacoplamento esforço–ciclo (padrão deixa de ser estereotipado).",
        limites:"Poucos ciclos observados reduzem a certeza."
      },
      confianca_regras:{
        sinais_chave:["esforco_pos_inicio_ciclo_mandatorio"],
        sinais_suporte:["repeticao_temporal"],
        conflitos:["artefato_movimento","ruido_sensor"]
      }
    }
  ]
};

const MEC_DB = {
  versao:"1.0",
  padroes:[
    {
      id:"resistencia_aumentada",
      padrao:"Resistência aumentada (padrão compatível)",
      micro:{
        sinal_chave:"Fluxo expiratório prolongado, com esvaziamento lento.",
        leitura:"Maior oposição ao fluxo aéreo, com aumento da constante de tempo.",
        confirmar:"Expiração mais longa e tendência a expiração incompleta quando o tempo expiratório é curto."
      },
      compacta:{
        sinais_dominantes:"Esvaziamento lento em fluxo; expiração prolongada; possível expiração incompleta em alta demanda.",
        leitura_fisiologica:"A resistência eleva a constante de tempo e retarda o esvaziamento.",
        como_diferenciar:"Predomínio de alterações na fase expiratória do fluxo.",
        observar_a_seguir:"Consistência do padrão em múltiplos ciclos e relação com truncamento expiratório.",
        se_resolver:"Expiração mais eficiente e retorno mais claro à linha de base.",
        limites:"Vazamentos e ruído podem distorcer linha de base e fluxo expiratório."
      },
      confianca_regras:{
        sinais_chave:["fluxo_expiratorio_prolongado_esvaziamento_lento"],
        sinais_suporte:["repeticao_temporal","expiracao_truncada_em_demanda","fluxo_expiratorio_nao_zera"],
        conflitos:["vazamento_importante","ruido_sensor","artefato_movimento","mudanca_modo"]
      }
    },
    {
      id:"complacencia_reduzida",
      padrao:"Complacência reduzida (padrão compatível)",
      micro:{
        sinal_chave:"Pequena variação de volume para variações de pressão ao longo do ciclo.",
        leitura:"Sistema mais rígido, com menor distensibilidade.",
        confirmar:"Padrão consistente de baixa variação volumétrica relativa."
      },
      compacta:{
        sinais_dominantes:"Variação volumétrica relativamente pequena frente a variações de pressão; padrão repetido.",
        leitura_fisiologica:"Menor distensibilidade reduz variação de volume por unidade de pressão.",
        como_diferenciar:"Leitura comparativa e consistente entre ciclos, sem valores absolutos.",
        observar_a_seguir:"Persistência do padrão e coerência pressão–volume ao longo do tempo.",
        se_resolver:"Maior variação volumétrica relativa para o mesmo padrão de pressão.",
        limites:"Mudanças de modo e ruído podem alterar forma das curvas."
      },
      confianca_regras:{
        sinais_chave:["baixa_variacao_volume_relativa_a_pressao"],
        sinais_suporte:["coerencia_pressao_volume","repeticao_temporal"],
        conflitos:["mudanca_modo","vazamento_importante","ruido_sensor","artefato_movimento"]
      }
    },
    {
      id:"atraso_pressurizacao",
      padrao:"Atraso de pressurização (padrão compatível)",
      micro:{
        sinal_chave:"Subida lenta de pressão no início da inspiração.",
        leitura:"Resposta mecânica lenta no começo do ciclo inspiratório.",
        confirmar:"Padrão repetido no começo da inspiração."
      },
      compacta:{
        sinais_dominantes:"Pressão sobe lentamente no início da inspiração; padrão repetitivo.",
        leitura_fisiologica:"Pressurização inicial lenta pode gerar desalinhamento com a demanda inicial.",
        como_diferenciar:"Sinal concentrado no começo da inspiração, com repetição temporal.",
        observar_a_seguir:"Coerência do padrão ao longo dos ciclos e sinais de esforço inicial.",
        se_resolver:"Subida inicial de pressão mais rápida e menor irregularidade inicial.",
        limites:"Forma depende do modo; interpretar no contexto do padrão esperado."
      },
      confianca_regras:{
        sinais_chave:["subida_lenta_pressao_inicio_inspiracao"],
        sinais_suporte:["repeticao_temporal","sinais_esforco_ao_longo_inspiracao"],
        conflitos:["ruido_sensor","artefato_movimento","mudanca_modo"]
      }
    },
    {
      id:"expiracao_incompleta_mecanica",
      padrao:"Expiração incompleta (mecânica do ciclo)",
      micro:{
        sinal_chave:"Fluxo expiratório não retorna à linha de base antes do próximo ciclo.",
        leitura:"Esvaziamento não se completa no tempo disponível.",
        confirmar:"Padrão consistente em múltiplos ciclos."
      },
      compacta:{
        sinais_dominantes:"Fluxo expiratório não zera; expiração truncada; padrão persistente.",
        leitura_fisiologica:"Tempo expiratório efetivo insuficiente frente à constante de tempo.",
        como_diferenciar:"Sinal-chave é o fluxo não zerar de forma consistente.",
        observar_a_seguir:"Persistência do fluxo pendente em múltiplos ciclos.",
        se_resolver:"Retorno do fluxo à linha de base antes do próximo ciclo.",
        limites:"Vazamento e linha de base instável podem mascarar retorno a zero."
      },
      confianca_regras:{
        sinais_chave:["fluxo_expiratorio_nao_zera"],
        sinais_suporte:["repeticao_temporal","expiracao_truncada_em_demanda"],
        conflitos:["vazamento_importante","ruido_sensor","artefato_movimento","mudanca_modo"]
      }
    },
    {
      id:"esforco_inspiratorio_sustentado",
      padrao:"Esforço inspiratório sustentado (padrão compatível)",
      micro:{
        sinal_chave:"Irregularidades inspiratórias sugerindo esforço ao longo da inspiração.",
        leitura:"Demanda inspiratória sustentada durante o ciclo.",
        confirmar:"Sinais com repetição, predominando durante a inspiração."
      },
      compacta:{
        sinais_dominantes:"Irregularidades inspiratórias com sinais de esforço ao longo da inspiração; repetição temporal.",
        leitura_fisiologica:"Demanda sustentada pode se expressar como deformação do fluxo/pressão durante a inspiração.",
        como_diferenciar:"Sinais aparecem durante a inspiração (não apenas no final).",
        observar_a_seguir:"Persistência em múltiplos ciclos e fase predominante.",
        se_resolver:"Traçado inspiratório mais regular e menor evidência de esforço.",
        limites:"Dependência do modo e de ruído; interpretar com cautela."
      },
      confianca_regras:{
        sinais_chave:["sinais_esforco_ao_longo_inspiracao"],
        sinais_suporte:["repeticao_temporal","coerencia_pressao_volume"],
        conflitos:["artefato_movimento","ruido_sensor","mudanca_modo"]
      }
    }
  ]
};

/* ========================= NAVEGAÇÃO ========================= */
function showTab(which){
  const secAss = document.getElementById("secAss");
  const secMec = document.getElementById("secMec");
  const secSobre = document.getElementById("secSobre");
  const tabAss = document.getElementById("tabAss");
  const tabMec = document.getElementById("tabMec");
  const tabSobre = document.getElementById("tabSobre");

  secAss.style.display = (which==="ass") ? "block" : "none";
  secMec.style.display = (which==="mec") ? "block" : "none";
  secSobre.style.display = (which==="sobre") ? "block" : "none";

  tabAss.classList.toggle("active", which==="ass");
  tabMec.classList.toggle("active", which==="mec");
  tabSobre.classList.toggle("active", which==="sobre");
}

/* ========================= UTIL ========================= */
function limparChecks(sectionId){
  const sec = document.getElementById(sectionId);
  sec.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  if(sectionId==="secAss"){ document.getElementById("outAss").style.display="none"; }
  if(sectionId==="secMec"){ document.getElementById("outMec").style.display="none"; }
}

function getCheckedSignals(sectionId){
  const sec = document.getElementById(sectionId);
  const signals = [];
  sec.querySelectorAll('input[type="checkbox"][data-signal]').forEach(cb=>{
    if(cb.checked) signals.push(cb.getAttribute("data-signal"));
  });
  return signals;
}

function getRadioValue(name){
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : "micro";
}

/* ========================= CONFIANÇA ========================= */
function calcConfianca(sinalChavePresente, nSuporte, nConflitos){
  if(sinalChavePresente === true && nSuporte >= 2 && nConflitos === 0) return "alta";
  if(
    (sinalChavePresente === true && nSuporte >= 1) ||
    (sinalChavePresente === false && nSuporte >= 3) ||
    (nConflitos === 1)
  ) return "media";
  return "baixa";
}

/* ========================= SCORING ========================= */
function scorePattern(pattern, checkedSignals){
  const key = pattern.confianca_regras?.sinais_chave || [];
  const sup = pattern.confianca_regras?.sinais_suporte || [];
  const conf = pattern.confianca_regras?.conflitos || [];

  const keyHit = key.some(s => checkedSignals.includes(s));
  const nSup = sup.filter(s => checkedSignals.includes(s)).length;
  const nConf = conf.filter(s => checkedSignals.includes(s)).length;

  // Score simples (robusto e previsível)
  let score = 0;
  if(keyHit) score += 3;
  score += nSup * 1;
  score -= nConf * 2;

  return {score, keyHit, nSup, nConf};
}

function topCandidates(list, checkedSignals, n=2){
  const ranked = list.map(p=>{
    const s = scorePattern(p, checkedSignals);
    return {p, ...s};
  }).sort((a,b)=> b.score - a.score);

  // filtra candidatos com score > 0 para evitar “resultado vazio” enganoso
  const filtered = ranked.filter(x => x.score > 0);
  return (filtered.length ? filtered : ranked.slice(0,1)).slice(0,n);
}

/* ========================= RENDER ========================= */
function renderMicro(item, confianca){
  return `
    <div class="kv"><b>Padrão:</b> ${escapeHtml(item.padrao)}</div>
    <div class="kv"><b>Confiança:</b> <span class="mono">${escapeHtml(confianca)}</span></div>
    <div class="kv"><b>Sinal-chave:</b> ${escapeHtml(item.micro.sinal_chave)}</div>
    <div class="kv"><b>Leitura:</b> ${escapeHtml(item.micro.leitura)}</div>
    <div class="kv"><b>Confirme observando:</b> ${escapeHtml(item.micro.confirmar)}</div>
  `;
}

function renderCompacta(item, confianca){
  const c = item.compacta;
  return `
    <div class="kv"><b>Padrão:</b> ${escapeHtml(item.padrao)}</div>
    <div class="kv"><b>Confiança:</b> <span class="mono">${escapeHtml(confianca)}</span></div>
    <div class="kv"><b>Sinais dominantes:</b> ${escapeHtml(c.sinais_dominantes)}</div>
    <div class="kv"><b>Leitura fisiológica:</b> ${escapeHtml(c.leitura_fisiologica)}</div>
    <div class="kv"><b>Como diferenciar:</b> ${escapeHtml(c.como_diferenciar)}</div>
    <div class="kv"><b>Observar a seguir:</b> ${escapeHtml(c.observar_a_seguir)}</div>
    <div class="kv"><b>Se resolver:</b> ${escapeHtml(c.se_resolver)}</div>
    <div class="kv"><b>Limites:</b> ${escapeHtml(c.limites)}</div>
  `;
}

function escapeHtml(str){
  return (str ?? "")
    .toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========================= AÇÕES ========================= */
function rodarAnaliseAss(){
  const checked = getCheckedSignals("secAss");
  const modo = getRadioValue("modo_saida_ass");

  const out = document.getElementById("outAss");
  const body = document.getElementById("outAssBody");

  if(checked.length === 0){
    out.style.display = "block";
    body.innerHTML = `<div class="small">Marque ao menos 1 sinal observável para gerar uma hipótese.</div>`;
    return;
  }

  const cand = topCandidates(ASS_DB.assincronias, checked, 2);

  let html = "";
  cand.forEach((c, idx)=>{
    const conf = calcConfianca(c.keyHit, c.nSup, c.nConf);
    html += `<div class="card" style="margin:10px 0;background:#fff;">
      <h3>${idx===0 ? "Hipótese principal" : "Hipótese alternativa"}</h3>
      ${modo==="micro" ? renderMicro(c.p, conf) : renderCompacta(c.p, conf)}
      <div class="small muted" style="margin-top:10px;">
        <b>Base da confiança (interno):</b> sinal-chave=${c.keyHit ? "sim":"não"}; suporte=${c.nSup}; conflitos=${c.nConf}.
      </div>
    </div>`;
  });

  html += `<div class="small" style="margin-top:8px;">
    <b>Aviso educacional:</b> Ferramenta educacional destinada à organização da leitura das curvas ventilatórias. Não orienta ajustes nem substitui julgamento clínico.
  </div>`;

  out.style.display = "block";
  body.innerHTML = html;
}

function rodarAnaliseMec(){
  const checked = getCheckedSignals("secMec");
  const modo = getRadioValue("modo_saida_mec");

  const out = document.getElementById("outMec");
  const body = document.getElementById("outMecBody");

  if(checked.length === 0){
    out.style.display = "block";
    body.innerHTML = `<div class="small">Marque ao menos 1 sinal observável para gerar uma hipótese.</div>`;
    return;
  }

  const cand = topCandidates(MEC_DB.padroes, checked, 2);

  let html = "";
  cand.forEach((c, idx)=>{
    const conf = calcConfianca(c.keyHit, c.nSup, c.nConf);
    html += `<div class="card" style="margin:10px 0;background:#fff;">
      <h3>${idx===0 ? "Hipótese principal" : "Hipótese alternativa"}</h3>
      ${modo==="micro" ? renderMicro(c.p, conf) : renderCompacta(c.p, conf)}
      <div class="small muted" style="margin-top:10px;">
        <b>Base da confiança (interno):</b> sinal-chave=${c.keyHit ? "sim":"não"}; suporte=${c.nSup}; conflitos=${c.nConf}.
      </div>
    </div>`;
  });

  html += `<div class="small" style="margin-top:8px;">
    <b>Aviso educacional:</b> Ferramenta educacional para interpretação de padrões em curvas ventilatórias. Não prescreve ajustes, não define alvos numéricos e não substitui julgamento clínico.
  </div>`;

  out.style.display = "block";
  body.innerHTML = html;
}
</script>
</body>
</html>
